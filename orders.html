<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="description" content="VON">
  <meta name="author" content="VON">
  <link rel="icon" type="image/png" href="img/icon-192x192.png">
  <title>Chawp</title>
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="vendor/icons/feather.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
  <style>
    
    html,body {
      height: 100vh;
      margin: 0;
      padding: 0;
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
      touch-action: pan-y;
      user-scalable: no;
      overscroll-behavior-y: none;
      -webkit-text-size-adjust: none;
      -webkit-overflow-scrolling: touch;
      font-family: 'Poppins', sans-serif;
    }
    body::-webkit-scrollbar { display: none; }
    body {
      display: flex;
      flex-direction: column;
      background: #2c2c2c;
      color: #fff;
    }
    .osahan-checkout {
      flex: 1 0 auto;
      padding-top: 70px;
      padding-bottom: calc(env(safe-area-inset-bottom) + 80px);
    }
    .bg-ash { background-color: #2c2c2c; }
    .order-box { cursor: pointer; transition: background 0.2s ease; }
    .order-box:hover { background: #1e1e1e; }
    .order-details { display: none; margin-top: 10px; }
    .order-box.expanded .order-details { display: block; }
    .order-summary { display: flex; justify-content: space-between; align-items: center; }
    input,textarea { font-size: 16px; outline: none; }
    *:focus { zoom: 1; }
    .status-badge {
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      display: inline-block;
      margin-top: 5px;
    }
    .status-pending { background: #ffc107; color: #212529; }
    .status-being_delivered { background: #007bff; color: #fff; }
    .status-delivered { background: #28a745; color: #fff; }
    .status-not_delivered { background: #dc3545; color: #fff; }
    .order-summary-left { flex: 1; }
    .order-summary-right { text-align: right; }

    .osahan-menu-fotter {
      padding: 10px;
      min-height: 70px;
      background: #1a1a1a;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
    }
    .footer-item {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1px;
      border-radius: 10px;
      transition: background 0.3s ease, transform 0.2s ease;
    }
    .footer-item.selected {
      background: #00566d;
      transform: scale(1.05);
    }
    .footer-item a {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .footer-item:hover { background: rgba(255,255,255,0.1); }
    .loading-placeholder {
      background: #3a3a3a;
      border-radius: 8px;
      height: 100px;
      margin-bottom: 10px;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }

    /* No Orders Screen Styling */
    .no-orders-screen {
      height: calc(100vh - 150px);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }
    .no-orders-screen i {
      font-size: 64px;
      color: #00b3e3;
      margin-bottom: 20px;
    }
    .no-orders-screen h2 {
      font-weight: 700;
      font-size: 24px;
      margin-bottom: 10px;
      color: #f8f8f8;
    }
    .no-orders-screen p {
      color: #aaa;
      font-size: 16px;
    }
    .spinner-border {
  animation-duration: 0.6s;
  
}

.status-pending {
  display: inline-block;
  padding: 6px 14px;
  font-size: 13px;
  font-weight: 600;
  border-radius: 999px;
  margin-top: 6px;
  letter-spacing: 0.4px;
  text-align: center;
  min-width: 120px;
  text-transform: uppercase;
  box-shadow: 0 1px 4px rgba(0,0,0,0.3);
  background: linear-gradient(to right, #e0e0e0, #f5f5f5);
  color: #333;
  border: 1px solid #ccc;
}

.status-accepted {
  display: inline-block;
  padding: 6px 14px;
  font-size: 13px;
  font-weight: 600;
  border-radius: 999px;
  margin-top: 6px;
  letter-spacing: 0.4px;
  text-align: center;
  min-width: 120px;
  text-transform: uppercase;
  box-shadow: 0 1px 4px rgba(0,0,0,0.3);
  background: linear-gradient(to right, #d0e7ff, #b0d0ff);
  color: #004085;
  border: 1px solid #90c0ff;
}

.status-preparing {
  display: inline-block;
  padding: 6px 14px;
  font-size: 13px;
  font-weight: 600;
  border-radius: 999px;
  margin-top: 6px;
  letter-spacing: 0.4px;
  text-align: center;
  min-width: 120px;
  text-transform: uppercase;
  box-shadow: 0 1px 4px rgba(0,0,0,0.3);
  background: linear-gradient(to right, #ffe0b2, #ffc266);
  color: #663c00;
  border: 1px solid #ffb84d;
}

.status-ready-for-pickup {
  display: inline-block;
  padding: 6px 14px;
  font-size: 13px;
  font-weight: 600;
  border-radius: 999px;
  margin-top: 6px;
  letter-spacing: 0.4px;
  text-align: center;
  min-width: 120px;
  text-transform: uppercase;
  box-shadow: 0 1px 4px rgba(0,0,0,0.3);
  background: linear-gradient(to right, #c7f2d2, #a4e7b8);
  color: #1b5e20;
  border: 1px solid #92d8a6;
}

.status-being_delivered {
  display: inline-block;
  padding: 6px 14px;
  font-size: 13px;
  font-weight: 600;
  border-radius: 999px;
  margin-top: 6px;
  letter-spacing: 0.4px;
  text-align: center;
  min-width: 120px;
  text-transform: uppercase;
  box-shadow: 0 1px 4px rgba(0,0,0,0.3);
  background: linear-gradient(to right, #e0d5f9, #d0c2f7);
  color: #5a2a82;
  border: 1px solid #c1acef;
}

.status-delivered {
  display: inline-block;
  padding: 6px 14px;
  font-size: 13px;
  font-weight: 600;
  border-radius: 999px;
  margin-top: 6px;
  letter-spacing: 0.4px;
  text-align: center;
  min-width: 120px;
  text-transform: uppercase;
  box-shadow: 0 1px 4px rgba(0,0,0,0.3);
  background: linear-gradient(to right, #d4edda, #c3e6cb);
  color: #155724;
  border: 1px solid #a8d5bb;
}

.status-not_delivered {
  display: inline-block;
  padding: 6px 14px;
  font-size: 13px;
  font-weight: 600;
  border-radius: 999px;
  margin-top: 6px;
  letter-spacing: 0.4px;
  text-align: center;
  min-width: 120px;
  text-transform: uppercase;
  box-shadow: 0 1px 4px rgba(0,0,0,0.3);
  background: linear-gradient(to right, #f8d7da, #f5c6cb);
  color: #721c24;
  border: 1px solid #f1aeb5;
}

.status-cancelled {
  display: inline-block;
  padding: 6px 14px;
  font-size: 13px;
  font-weight: 600;
  border-radius: 999px;
  margin-top: 6px;
  letter-spacing: 0.4px;
  text-align: center;
  min-width: 120px;
  text-transform: uppercase;
  box-shadow: 0 1px 4px rgba(0,0,0,0.3);
  background: linear-gradient(to right, #f5c6cb, #e99aa0);
  color: #7a0b0b;
  border: 1px solid #e49098;
}

  </style>

</head>
<body class="fixed-bottom-bar">
  <div class="osahan-checkout">
    <div class="bg-ash border-bottom p-3 d-flex align-items-center fixed-top" style="z-index: 1040;">
      <h4 class="fw-bold m-0 text-white"><i class="feather-shopping-bag me-2"></i>My Orders</h4>
    </div>

    <div class="container py-5">
      <div id="orders-list">
       <div class="spinner-wrapper d-flex justify-content-center align-items-center" style="height: 300px;">
  <div class="spinner-border text-info" role="status" style="width: 3rem; height: 3rem;">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

      </div>
    </div>
  </div>

  <div class="osahan-menu-fotter fixed-bottom bg-darks px-3 py-2 text-center">
    <div class="row">
      <div class="col"><div class="footer-item"><a href="index.html" class="text-white small fw-bold text-decoration-none"><p class="h4 m-0"><i class="feather-map-pin text-white"></i></p>Trending</a></div></div>
      <div class="col"><div class="footer-item"><a href="home.html" class="text-white small fw-bold text-decoration-none"><p class="h4 m-0"><i class="feather-home text-white"></i></p>Home</a></div></div>
      <div class="col"><div class="footer-item"><a href="cart.html" class="text-white small fw-bold text-decoration-none"><p class="h4 m-0"><i class="feather-shopping-cart"></i></p>Cart</a></div></div>
      <div class="col"><div class="footer-item selected"><a href="orders.html" class="text-white small fw-bold text-decoration-none"><p class="h4 m-0"><i class="feather-shopping-bag"></i></p>Orders</a></div></div>
      <div class="col"><div class="footer-item"><a href="profile.html" class="text-white small fw-bold text-decoration-none"><p class="h4 m-0"><i class="feather-user"></i></p>Profile</a></div></div>
    </div>
  </div>

  <script type="module">
    
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getFirestore, collection, query, getDoc, doc, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

        const firebaseConfig = {
    apiKey: "AIzaSyADvpUQWo75ExePGoCRirD2mM-lmfM4Cmc",
    authDomain: "von600-7982d.firebaseapp.com",
    projectId: "von600-7982d",
    storageBucket: "von600-7982d.appspot.com",
    messagingSenderId: "164591218045",
    appId: "1:164591218045:web:afe17512e16573e7903014",
    measurementId: "G-E69DMPLXBK"
};

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
let markupPrice = 0;

async function fetchMarkupPrice() {
  try {
    const markupDoc = await getDoc(doc(db, "settings", "markup"));
    if (markupDoc.exists()) {
      markupPrice = parseFloat(markupDoc.data().amount) || 0;
      console.log("Markup price:", markupPrice);
    }
  } catch (err) {
    console.warn("Failed to fetch markup price", err);
  }
}


        const ordersList = document.getElementById("orders-list");

        const getDeviceId = (() => {
            let deviceId = localStorage.getItem("deviceId");
            if (!deviceId) {
                deviceId = "device_" + Math.random().toString(36).substr(2, 9) + "_" + Date.now();
                localStorage.setItem("deviceId", deviceId);
            }
            return () => deviceId;
        })();

        const isValidOrder = (order) => {
  if (!order.cart || !Array.isArray(order.cart)) return false;
  return order.cart.every(item =>
    typeof item.name === "string" && item.name !== "undefined" &&
    typeof item.quantity === "number" && !isNaN(item.quantity) &&
    (typeof item.total === "number" || (typeof item.price === "number" && !isNaN(item.price)))
  );
};

function getStatusDetails(status) {
  const statusMap = {
    pending:         { text: "ðŸ• Pending", class: "status-pending" },
    accepted:        { text: "âœ… Accepted", class: "status-accepted" },
    preparing:       { text: "ðŸ³ Preparing", class: "status-preparing" },
    "ready-for-pickup": { text: "ðŸ“¦ Ready for Pickup", class: "status-ready-for-pickup" },
    being_delivered: { text: "ðŸšš Being Delivered", class: "status-being_delivered" },
    delivered:       { text: "âœ… Delivered", class: "status-delivered" },
    not_delivered:   { text: "âŒ Not Delivered", class: "status-not_delivered" },
    cancelled:       { text: "âŒ Cancelled", class: "status-cancelled" },
  };

  return statusMap[status] || { text: status, class: "status-gray" };
}


        const loadOrders = () => {
  const deviceId = getDeviceId();
  const ordersRef = collection(db, "orders");
  const q = query(ordersRef, where("deviceId", "==", deviceId));

  onSnapshot(q, (querySnapshot) => {
    if (querySnapshot.empty) {
  ordersList.innerHTML = `
    <div class="no-orders-screen">
      <i class="feather-shopping-bag"></i>
      <h2>No Orders Yet</h2>
      <p>Why you no dey hung?</p>
    </div>`;
  return;
}


    const validOrders = querySnapshot.docs
      .map(doc => ({ id: doc.id, ...doc.data() }))
      .filter(order => isValidOrder(order));

    if (!validOrders.length) {
      ordersList.innerHTML = "<p class='text-center text-white'>No valid orders yet.</p>";
      return;
    }

    const groupCartItems = (cart) => {
  const grouped = {};
  cart.forEach(item => {
    const extrasKey = item.extras ? item.extras.map(e => `${e.name}:${e.quantity}`).join("|") : "";
    const sizeKey = item.size || "";
    const key = `${item.name}-${item.price}-${sizeKey}-${extrasKey}`;

    if (!grouped[key]) {
      grouped[key] = { ...item, quantity: 0 };
    }
    grouped[key].quantity += item.quantity;
  });
  return Object.values(grouped);
};


    const fragment = document.createDocumentFragment();
    validOrders
      .sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis())
      .forEach(order => {
        const orderTime = order.timestamp.toDate().toLocaleString();

        // ðŸ”¥ Group identical items!
        const groupedCart = groupCartItems(order.cart);

        const itemsListSummary = groupedCart.map(item => `${item.quantity}x ${item.name}`).join(", ");
        const itemsListFull = groupedCart.map(item => {
  const itemTotal = typeof item.total === "number" ? item.total.toFixed(2) : ((item.price + markupPrice) * item.quantity).toFixed(2);

  const sizeInfo = item.size
    ? `<div style="font-size: 0.8rem; color: #aaa;"><strong>Size:</strong> ${item.size}</div>`
    : "";

  const extrasInfo = item.extras && item.extras.length > 0
    ? `<div style="font-size: 0.8rem; color: #ccc;"><strong>Extras:</strong> ${item.extras.map(e => `${e.name} Ã—${e.quantity}`).join(", ")}</div>`
    : "";

  return `
    <li class="text-white small mb-2">
      <div><strong>${item.quantity}x ${item.name}</strong> - GHâ‚µ${itemTotal}</div>
      ${sizeInfo}
      ${extrasInfo}
    </li>
  `;
}).join("");


        const subtotal = groupedCart.reduce((sum, item) => {
          const itemTotal = typeof item.total === "number" ? item.total : (item.price + markupPrice) * item.quantity;
          return sum + itemTotal;
        }, 0);

        const processingFee = order.processingFee || 2.00;
const baseDeliveryFee = order.deliveryFee || 3.00;
const totalMealCount = groupedCart.reduce((sum, item) => sum + item.quantity, 0);
const finalDeliveryFee = baseDeliveryFee + Math.max(0, (totalMealCount - 1) * 2);
const total = (subtotal + processingFee + finalDeliveryFee);
        const { text: statusText, class: statusClass } = getStatusDetails(order.status || "pending");

        const orderDiv = document.createElement("div");
        orderDiv.className = "order-box bg-darkish p-3 mb-3 rounded";
        orderDiv.innerHTML = `
          <div class="order-summary">
            <div class="order-summary-left">
              <h5 class="fw-bold text-white">Order on ${orderTime}</h5>
              <p class="order-id text-white-50 small">Order ID: <span>${order.id}</span></p>
              <p class="text-white small">${itemsListSummary}<br> <span class="${statusClass}">${statusText}</span></p>
            </div>
            <div class="order-summary-right">
              <p class="order-total text-white fw-bold">GHâ‚µ${total.toFixed(2)}</p>
            </div>
          </div>
          <div class="order-details">
            <hr class="bg-light">
            <ul class="list-unstyled">${itemsListFull}</ul>
            <hr class="bg-light">
            <p class="text-white small">Subtotal: GHâ‚µ${subtotal.toFixed(2)}</p>
            <p class="text-white small">Processing Fee: GHâ‚µ${processingFee.toFixed(2)}</p>
<p class="text-white small">Delivery Fee: GHâ‚µ${finalDeliveryFee.toFixed(2)}</p>
            <p class="text-white small">Location: ${order.deliveryDetails.hostel}, Room ${order.deliveryDetails.location}</p>
            <hr class="bg-light">
            <p class="order-total text-white fw-bold">Total: GHâ‚µ${total.toFixed(2)}</p>
          <a href="track.html?id=${order.id}" class="btn btn-sm btn-outline-info mt-2 w-100">Track Order</a>
            </div>`;
orderDiv.addEventListener("click", (e) => {
  // Let buttons or links inside the card behave normally
  if (e.target.closest("a, button")) return;

  orderDiv.classList.toggle("expanded");
});
        fragment.appendChild(orderDiv);
      });

    ordersList.innerHTML = "";
    ordersList.appendChild(fragment);
  }, (error) => {
    console.error("Error loading orders:", error);
    ordersList.innerHTML = "<p class='text-center text-white'>Error loading orders.</p>";
  });
};

fetchMarkupPrice().then(() => loadOrders());
        feather.replace();
    
  </script>
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="/register-sw.js"></script>

</body>
</html>