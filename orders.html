<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="description" content="VON">
  <meta name="author" content="VON">
  <link rel="icon" type="image/png" href="img/icon-192x192.png">
  <title>Chawp</title>
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="vendor/icons/feather.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
<link href="css/orders.css" rel="stylesheet">
</head>
<body class="fixed-bottom-bar">
  <div class="osahan-checkout">
    <div class="bg-ash border-bottom p-3 d-flex align-items-center fixed-top" style="z-index: 1040;">
      <h4 class="fw-bold m-0 text-white"><i class="feather-shopping-bag me-2"></i>My Orders</h4>
    </div>

    <div class="container py-5">
      <div id="orders-list">
       <div class="spinner-wrapper d-flex justify-content-center align-items-center" style="height: 300px;">
  <div class="spinner-border text-info" role="status" style="width: 3rem; height: 3rem;">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

      </div>
    </div>
  </div>

  <div class="osahan-menu-fotter fixed-bottom bg-darks px-3 py-2 text-center">
    <div class="row">
      <div class="col"><div class="footer-item"><a href="index.html" class="footer-tab text-white small fw-bold text-decoration-none"><p class="h4 m-0"><i class="feather-map-pin text-white"></i></p>Trending</a></div></div>
      <div class="col"><div class="footer-item"><a href="home.html" class="footer-tab text-white small fw-bold text-decoration-none"><p class="h4 m-0"><i class="feather-home text-white"></i></p>Home</a></div></div>
      <div class="col"><div class="footer-item"><a href="cart.html" class="footer-tab text-white small fw-bold text-decoration-none"><p class="h4 m-0"><i class="feather-shopping-cart"></i></p>Cart</a></div></div>
      <div class="col"><div class="footer-item selected"><a href="orders.html" class="footer-tab text-white small fw-bold text-decoration-none"><p class="h4 m-0"><i class="feather-shopping-bag"></i></p>Orders</a></div></div>
      <div class="col"><div class="footer-item"><a href="profile.html" class="footer-tab text-white small fw-bold text-decoration-none"><p class="h4 m-0"><i class="feather-user"></i></p>Profile</a></div></div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
import { 
  getFirestore, collection, getDocs, doc, getDoc 
} from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyADvpUQWo75ExePGoCRirD2mM-lmfM4Cmc",
  authDomain: "von600-7982d.firebaseapp.com",
  projectId: "von600-7982d",
  storageBucket: "von600-7982d.appspot.com",
  messagingSenderId: "164591218045",
  appId: "1:164591218045:web:afe17512e16573e7903014",
  measurementId: "G-E69DMPLXBK"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const ordersList = document.getElementById("orders-list");

let markupPrice = 0;

// Fetch markup once
async function fetchMarkupPrice() {
  try {
    const markupDoc = await getDoc(doc(db, "settings", "markup"));
    if (markupDoc.exists()) markupPrice = parseFloat(markupDoc.data().amount) || 0;
  } catch (err) {
    console.warn("Failed to fetch markup price", err);
  }
}

// Status map
function getStatusDetails(status) {
  const map = {
    pending: { text: "üïê Pending", class: "status-pending" },
    accepted: { text: "‚úÖ Accepted", class: "status-accepted" },
    preparing: { text: "üç≥ Preparing", class: "status-preparing" },
    "ready-for-pickup": { text: "üì¶ Ready for Pickup", class: "status-ready-for-pickup" },
    being_delivered: { text: "üöö Being Delivered", class: "status-being_delivered" },
    delivered: { text: "‚úÖ Delivered", class: "status-delivered" },
    cancelled: { text: "‚ùå Cancelled", class: "status-cancelled" },
  };
  return map[status] || { text: status, class: "status-gray" };
}

// Main loader
async function loadOrdersForUser(userEmail) {
  ordersList.innerHTML = `<p class="text-center text-white mt-5">Loading orders...</p>`;

  try {
    const [ordersSnap, archivedSnap] = await Promise.all([
      getDocs(collection(db, "orders")),
      getDocs(collection(db, "archivedOrders"))
    ]);

    // Combine and filter both collections
    const allOrders = [...ordersSnap.docs, ...archivedSnap.docs]
      .map(d => ({ id: d.id, ...d.data() }))
      .filter(o => o.email === userEmail || o.userEmail === userEmail);

    if (allOrders.length === 0) {
      ordersList.innerHTML = `
        <div class="no-orders-screen">
          <i class="feather-shopping-bag"></i>
          <h2>No Orders Yet</h2>
          <p>Why you no dey hung?</p>
        </div>`;
      return;
    }

    // Sort newest first
    allOrders.sort((a, b) => {
      const timeA = a.timestamp?.toMillis?.() || new Date(a.timestamp || a.archivedAt || 0).getTime();
      const timeB = b.timestamp?.toMillis?.() || new Date(b.timestamp || b.archivedAt || 0).getTime();
      return timeB - timeA;
    });

    // Batch render for speed
    const fragment = document.createDocumentFragment();
    for (const order of allOrders) {
      const orderTime = new Date(
        order.timestamp?.toDate?.() || order.timestamp || order.archivedAt || Date.now()
      ).toLocaleString();

      const cart = order.cart || [];
      const subtotal = cart.reduce((sum, item) => {
        const itemPrice = item.total ?? (item.price + markupPrice) * item.quantity;
        return sum + itemPrice;
      }, 0);

      const processingFee = order.processingFee ?? 2;
      const deliveryFee = order.finalDeliveryFee ?? order.deliveryFee ?? 3;
      const total = subtotal + processingFee + deliveryFee;
      const { text: statusText, class: statusClass } = getStatusDetails(order.status || "pending");

      const orderBox = document.createElement("div");
      orderBox.className = "order-box bg-darkish p-3 mb-3 rounded";
      orderBox.innerHTML = `
        <div class="order-summary">
          <div>
            <h5 class="fw-bold text-white">Order on ${orderTime}</h5>
            <p class="text-white-50 small">Order ID: ${order.id}</p>
            <p class="text-white small">
              ${cart.map(i => `${i.quantity}x ${i.name}`).join(", ")}<br>
              <span class="${statusClass}">${statusText}</span>
            </p>
          </div>
          <div>
            <p class="text-white fw-bold">GH‚Çµ${total.toFixed(2)}</p>
          </div>
        </div>
        <div class="order-details">
          <hr class="bg-light">
          <ul class="list-unstyled">
            ${cart.map(i => `
              <li class="text-white small mb-1">${i.quantity}x ${i.name} ‚Äî GH‚Çµ${((i.price + markupPrice) * i.quantity).toFixed(2)}</li>
            `).join("")}
          </ul>
          <hr class="bg-light">
          <p class="text-white small">Subtotal: GH‚Çµ${subtotal.toFixed(2)}</p>
          <p class="text-white small">Processing Fee: GH‚Çµ${processingFee.toFixed(2)}</p>
          <p class="text-white small">Delivery Fee: GH‚Çµ${deliveryFee.toFixed(2)}</p>
          <p class="text-white fw-bold">Total: GH‚Çµ${total.toFixed(2)}</p>
          <a href="track.html?id=${order.id}" class="btn btn-sm btn-outline-info mt-2 w-100">Track Order</a>
        </div>
      `;

      orderBox.addEventListener("click", e => {
        if (!e.target.closest("a,button")) orderBox.classList.toggle("expanded");
      });
      fragment.appendChild(orderBox);
    }

    ordersList.innerHTML = "";
    ordersList.appendChild(fragment);

  } catch (err) {
    console.error("Error loading orders:", err);
    ordersList.innerHTML = `<p class="text-center text-danger mt-5">Failed to load orders.</p>`;
  }
}

// Auth listener
onAuthStateChanged(auth, user => {
  if (user?.email) {
    fetchMarkupPrice().then(() => loadOrdersForUser(user.email));
  } else {
    ordersList.innerHTML = `<p class="text-center text-white mt-5">Please log in to see your orders.</p>`;
  }
});
</script>



  <script src="https://unpkg.com/feather-icons"></script>
  <script type="module" src="/register-sw.js"></script>


<script>
  document.querySelectorAll('a.footer-tab').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const baseUrl = link.getAttribute('href').split('?')[0];
      const timestamp = Date.now();
      window.location.href = `${baseUrl}?refresh=${timestamp}`;
    });
  });
</script>

</body>
</html>