<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="description" content="Chawp - Sleek Food Delivery">
    <meta name="author" content="Askbootstrap">
    <meta name="theme-color" content="#2c2c2c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/png" href="img/fav.png">
    <link rel="apple-touch-icon" href="img/icon-192x192.png">
    <title>Chawp</title>
    <link href="vendor/icons/feather.css" rel="stylesheet" type="text/css">
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <link href="css/style.css" rel="stylesheet">

    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(async function(OneSignal) {
            await OneSignal.init({
                appId: "f69ee07c-2405-4210-a18f-c6842db4c294",
            });
        });
    </script>

    <style>
        body {background:#2c2c2c;font-family:'Poppins', sans-serif;color:#fff;overflow-x:hidden;}
        .trending-section {padding:40px 0;opacity:0;transition:opacity 0.5s ease;}
        .trending-section.loaded {opacity:1;}
        .section-title {font-size:2rem;font-weight:700;margin-bottom:20px;color:#fff;text-align:center;}
        #trending-list {display:grid;grid-template-columns:repeat(2,1fr);gap:20px;padding:15px;}
        .list-card {background:#565656;border-radius:10px;overflow:hidden;transition:transform 0.3s ease,box-shadow 0.3s ease,opacity 0.5s ease;opacity:0;}
        .list-card.loaded {opacity:1;}
        .list-card:hover {transform:translateY(-8px);box-shadow:0 12px 24px rgba(0,0,0,0.3);}
        .list-card-image img {height:110px;object-fit:cover;width:100%;border-radius:10px 10px 0 0;filter:brightness(0.9);transition:filter 0.3s ease;}
        .list-card:hover .list-card-image img {filter:brightness(1);}
        .list-card-body {padding:8px;text-align:left;height:60px;}
        .list-card-body h6 {font-size:1rem;font-weight:600;color:#fff;margin-bottom:4px;overflow-wrap:break-word;white-space:normal;max-height:32px;line-height:1.1;}
        .time {font-size:0.75rem;color:#b0b0b0;margin-top:2px;}
        .time span {background:#4a4a4a;color:#fff;padding:3px 8px;border-radius:12px;}
        .trending-text {color:#fff;font-weight:600;}
        .text-danger {color:#00c8ff;transition:color 0.3s ease,transform 0.2s ease;}
        .text-danger:hover {color:#00c8ff;transform:scale(1.05);}
        html, body {-webkit-text-size-adjust:none;touch-action:manipulation;-webkit-user-select:none;-ms-user-select:none;user-select:none;-webkit-touch-callout:none;padding-bottom:calc(70px + env(safe-area-inset-bottom));}
        input, textarea {font-size:16px;outline:none;-webkit-user-select:text !important;user-select:text !important;-webkit-touch-callout:default !important;touch-action:auto !important;}
        *:focus {zoom:1 !important;}
        .offline-notice {display:none;text-align:center;padding:15px;color:#fff;background:#ff3b30;border-radius:12px;margin:20px 10px;font-size:0.9rem;opacity:0;transition:opacity 0.5s ease;}
        body.offline .offline-notice {display:block;opacity:1;}
        .welcome-header {padding:30px 20px;text-align:center;background:linear-gradient(135deg, #565656, #4a4a4a);border-radius:30px;margin:15px;box-shadow:0 8px 20px rgba(0,0,0,0.3);position:relative;overflow:hidden;opacity:0;transition:opacity 0.5s ease;}
        .welcome-header.loaded {opacity:1;}
        .welcome-header::before {content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle, rgba(255,255,255,0.05), transparent);animation:glow 6s infinite;}
        .welcome-header h1 {font-size:2.5rem;font-weight:800;margin:0;letter-spacing:-0.5px;color:#fff;animation:fadeIn 1s ease-in;}
        .welcome-header p {font-size:1.2rem;opacity:0.85;margin:8px 0 0;font-weight:300;color:#b0b0b0;animation:fadeIn 1.5s ease-in;}
        .promo-banner {margin:25px 15px;padding:20px;background:#565656;border-radius:15px;text-align:center;color:#fff;box-shadow:0 6px 15px rgba(0,0,0,0.3);cursor:pointer;transition:transform 0.3s ease,box-shadow 0.3s ease,opacity 0.5s ease;opacity:0;}
        .promo-banner.loaded {opacity:1;}
        .promo-banner:hover {transform:scale(1.03);box-shadow:0 10px 25px rgba(0,0,0,0.35);}
        .promo-banner h3 {font-size:1.8rem;margin:0;color:#00c8ff;font-weight:700;letter-spacing:-0.2px;}
        .promo-banner p {font-size:1rem;margin:8px 0 0;opacity:0.9;font-weight:400;color:#b0b0b0;}
        .osahan-menu-fotter {background:#c60000;box-shadow:0 -4px 15px rgba(0,0,0,0.3);padding:15px 0;opacity:0;transition:opacity 0.5s ease;}
        .osahan-menu-fotter.loaded {opacity:1;}
        .osahan-menu-fotter a {transition:color 0.3s ease,transform 0.2s ease;}
        .osahan-menu-fotter a:hover {transform:scale(1.1);}
        @keyframes fadeIn {from {opacity:0;transform:translateY(10px);} to {opacity:1;transform:translateY(0);}}
        @keyframes glow {0% {transform:rotate(0deg);} 50% {transform:rotate(180deg);} 100% {transform:rotate(360deg);}}
        @media (max-width: 576px) {
            .welcome-header h1 {font-size:2rem;}
            .welcome-header p {font-size:1rem;}
            .promo-banner h3 {font-size:1.5rem;}
            .promo-banner p {font-size:0.9rem;}
        }
        .bg-darks{
            background: #1a1a1a;
            color: #00c8ff;
        }
    </style>
</head>
<body class="fixed-bottom-bar">
    <!-- Loading screen with "Chawp" centered -->
    <div id="loading-screen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c2c2c; display: none; align-items: center; justify-content: center; z-index: 3000;">
        <h1 style="font-size: 3rem; font-weight: 600; letter-spacing: -2px; background: linear-gradient(45deg, #007aff, #34c759, #007aff); -webkit-background-clip: text; background-clip: text; color: transparent;">Chawp</h1>
    </div>

    <!-- Main content -->
    <div id="main-content" class="osahan-home-page">
        <div class="welcome-header">
            <div class="title d-flex align-items-center justify-content-center">
                <h1 id="welcome-message">Hi!</h1>
            </div>
            <p>Abi you dey hung?</p>
        </div>
        <div class="promo-banner" onclick="location.href='home.html'">
            <h3>Swift Delivery, At Your Door!</h3>
            <p>Order now and enjoy delicious food in minutes.</p>
        </div>
    </div>

    <div id="trending-section" class="trending-section">
        <div class="container">
            <div class="d-flex align-items-center">
                <h5 class="trending-text">Trending Now 🔥</h5>
                <a class="fw-bold ms-auto text-white" href="home.html">All <i class="feather-chevrons-right"></i></a>
            </div>
            <div class="offline-notice">You’re offline. Showing cached content.</div>
            <div id="trending-list"></div>
        </div>
    </div>

    <div id="footer-nav" class="osahan-menu-fotter fixed-bottom bg-darks px-3 py-2 text-center">
        <div class="row">
            <div class="col selected">
                <a href="index.html" class="text-danger small fw-bold text-decoration-none">
                    <p class="h4 m-0"><i class="feather-map-pin text-danger"></i></p>Trending
                </a>
            </div>
            <div class="col">
                <a href="home.html" class="text-white small fw-bold text-decoration-none">
                    <p class="h4 m-0"><i class="feather-home text-white"></i></p>Home
                </a>
            </div>
            <div class="col">
                <a href="cart.html" class="text-white small fw-bold text-decoration-none">
                    <p class="h4 m-0"><i class="feather-shopping-cart"></i></p>Cart
                </a>
            </div>
            <div class="col">
                <a href="orders.html" class="text-white small fw-bold text-decoration-none">
                    <p class="h4 m-0"><i class="feather-shopping-bag"></i></p>Orders
                </a>
            </div>
            <div class="col">
                <a href="profile.html" class="text-white small fw-bold text-decoration-none">
                    <p class="h4 m-0"><i class="feather-user"></i></p>Profile
                </a>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, orderBy, limit, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyADvpUQWo75ExePGoCRirD2mM-lmfM4Cmc",
            authDomain: "von600-7982d.firebaseapp.com",
            projectId: "von600-7982d",
            storageBucket: "von600-7982d.appspot.com",
            messagingSenderId: "164591218045",
            appId: "1:164591218045:web:afe17512e16573e7903014",
            measurementId: "G-E69DMPLXBK"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Enable offline persistence
        enableIndexedDbPersistence(db).catch(err => console.warn("Firestore persistence failed:", err));

        // Cache DOM elements
        const loadingScreen = document.getElementById("loading-screen");
        const mainContent = document.getElementById("main-content");
        const trendingSection = document.getElementById("trending-section");
        const footerNav = document.getElementById("footer-nav");
        const trendingList = document.getElementById("trending-list");
        const welcomeMessage = document.getElementById("welcome-message");

        // Check if running in standalone mode (PWA installed)
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

        // Load trending restaurants
        async function loadTrendingRestaurants() {
            const cachedData = localStorage.getItem("trendingRestaurants");
            if (cachedData && !navigator.onLine) {
                trendingList.innerHTML = cachedData;
                document.body.classList.add("offline");
                showContent(false);
                return;
            }

            trendingList.innerHTML = "<p style='color:#b0b0b0;'>Loading restaurants...</p>";
            try {
                const q = query(collection(db, "restaurant"), orderBy("rating", "desc"), limit(6));
                const querySnapshot = await getDocs(q);
                const fragment = document.createDocumentFragment();

                if (querySnapshot.empty) {
                    trendingList.innerHTML = "<p style='color:#b0b0b0;'>No trending restaurants found.</p>";
                    showContent(true);
                    return;
                }

                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const restaurantId = doc.id;
                    const item = document.createElement("div");
                    item.className = "list-card";
                    item.innerHTML = `
                        <div class="list-card-image">
                            <a href="restaurant.html?id=${restaurantId}">
                                <img alt="${data.name || 'Restaurant'}" src="${data.image || 'img/placeholder.png'}" class="img-fluid item-img" loading="lazy">
                            </a>
                        </div>
                        <div class="list-card-body">
                            <h6 class="mb-1"><a href="restaurant.html?id=${restaurantId}" class="text-white">${data.name || 'Unnamed'}</a></h6>
                            <p class="time"><a href="restaurant.html?id=${restaurantId}"><span><i class="feather-clock me-1"></i>${Math.max(5, data.delivery_time - 15)}-${data.delivery_time} mins</span></a></p>
                        </div>
                    `;
                    fragment.appendChild(item);
                });

                trendingList.innerHTML = "";
                trendingList.appendChild(fragment);
                localStorage.setItem("trendingRestaurants", trendingList.innerHTML);
                document.body.classList.remove("offline");
                showContent(true);

            } catch (error) {
                console.error("❌ ERROR fetching trending restaurants:", error);
                if (cachedData) {
                    trendingList.innerHTML = cachedData;
                    document.body.classList.add("offline");
                } else {
                    trendingList.innerHTML = "<p style='color:#b0b0b0;'>Failed to load restaurants.</p>";
                }
                showContent(true);
            }
        }

        // Update welcome message
        function updateWelcomeMessage() {
            const cachedUser = localStorage.getItem("user-account-cache-" + (auth.currentUser?.uid || ""));
            if (cachedUser) {
                const { name } = JSON.parse(cachedUser);
                welcomeMessage.textContent = `Hi, ${name || "User"}!`;
            } else {
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        const cachedData = localStorage.getItem("user-account-cache-" + user.uid);
                        if (cachedData) {
                            const { name } = JSON.parse(cachedData);
                            welcomeMessage.textContent = `Hi, ${name || "User"}!`;
                        } else {
                            welcomeMessage.textContent = `Hi, ${user.email.split("@")[0]}!`;
                        }
                    }
                });
            }
        }

        // Show content with optional loading screen
        function showContent(useLoadingScreen) {
            if (useLoadingScreen && !localStorage.getItem("hasLoadedOnce")) {
                loadingScreen.style.display = "flex";
                setTimeout(() => {
                    loadingScreen.style.display = "none";
                    mainContent.style.display = "block";
                    trendingSection.style.display = "block";
                    footerNav.style.display = "block";
                    applyFadeIns();
                    localStorage.setItem("hasLoadedOnce", "true");
                }, 1000); // Show loading screen for 1s on first load
            } else {
                loadingScreen.style.display = "none";
                mainContent.style.display = "block";
                trendingSection.style.display = "block";
                footerNav.style.display = "block";
                applyFadeIns();
            }
        }

        // Apply fade-in animations
        function applyFadeIns() {
            setTimeout(() => {
                document.querySelector(".welcome-header").classList.add("loaded");
                document.querySelector(".promo-banner").classList.add("loaded");
                trendingSection.classList.add("loaded");
                footerNav.classList.add("loaded");
                document.querySelectorAll(".list-card").forEach(card => card.classList.add("loaded"));
            }, 50);
        }

        // Initialize on DOM load
        document.addEventListener("DOMContentLoaded", () => {
            // Reset flag if in standalone mode and app is freshly opened
            if (isStandalone && !sessionStorage.getItem("appSessionActive")) {
                localStorage.removeItem("hasLoadedOnce");
                sessionStorage.setItem("appSessionActive", "true");
            }

            loadTrendingRestaurants();
            updateWelcomeMessage();

            if ("serviceWorker" in navigator) {
                navigator.serviceWorker.register("service-worker.js")
                    .then(() => console.log("PWA Ready!"))
                    .catch(error => console.error("PWA Error:", error));
            }
        });

        // Network status listeners
        window.addEventListener("online", loadTrendingRestaurants);
        window.addEventListener("offline", () => {
            const cachedData = localStorage.getItem("trendingRestaurants");
            if (cachedData) {
                trendingList.innerHTML = cachedData;
                document.body.classList.add("offline");
                showContent(false);
            }
        });

        // Push notification setup
        if ("serviceWorker" in navigator && "PushManager" in window) {
            navigator.serviceWorker.register("/service-worker.js")
                .then(registration => {
                    Notification.requestPermission().then(permission => {
                        if (permission === "granted") {
                            registration.pushManager.subscribe({
                                userVisibleOnly: true,
                                applicationServerKey: "YOUR_VAPID_PUBLIC_KEY"
                            }).then(subscription => {
                                fetch("https://progressier.app/YOUR_APP_ID/subscribe", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                        "Authorization": "Token YOUR_API_TOKEN"
                                    },
                                    body: JSON.stringify(subscription)
                                }).then(response => {
                                    console.log(response.ok ? "Subscribed!" : "Subscription failed.");
                                }).catch(error => console.error("Push error:", error));
                            });
                        }
                    });
                })
                .catch(error => console.error("Service Worker reg failed:", error));
        }

        // Reset session flag when app is closed in standalone mode
        window.addEventListener("beforeunload", () => {
            if (isStandalone) {
                sessionStorage.removeItem("appSessionActive");
            }
        });
    </script>
    <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'927746ef38e553de',t:'MTc0MzE2NjQ3Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
    <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'92a9c8b1491144ef',t:'MTc0MzY5NjA3OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>     