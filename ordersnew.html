<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="description" content="VON">
  <meta name="author" content="VON">
  <link rel="icon" type="image/png" href="img/icon-192x192.png">
  <title>Chawp</title>
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="vendor/icons/feather.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
<link href="css/orders.css" rel="stylesheet">
</head>
<body class="fixed-bottom-bar">
  <div class="osahan-checkout">
    <div class="bg-ash border-bottom p-3 d-flex align-items-center fixed-top" style="z-index: 1040;">
      <h4 class="fw-bold m-0 text-white"><i class="feather-shopping-bag me-2"></i>My Orders</h4>
    </div>

    <div class="container py-5">
      <div id="orders-list">
       <div class="spinner-wrapper d-flex justify-content-center align-items-center" style="height: 300px;">
  <div class="spinner-border text-info" role="status" style="width: 3rem; height: 3rem;">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

      </div>
    </div>
  </div>

  <div class="osahan-menu-fotter fixed-bottom bg-darks px-3 py-2 text-center">
    <div class="row">
      <div class="col"><div class="footer-item"><a href="index.html" class="footer-tab text-white small fw-bold text-decoration-none"><p class="h4 m-0"><i class="feather-map-pin text-white"></i></p>Trending</a></div></div>
      <div class="col"><div class="footer-item"><a href="home.html" class="footer-tab text-white small fw-bold text-decoration-none"><p class="h4 m-0"><i class="feather-home text-white"></i></p>Home</a></div></div>
      <div class="col"><div class="footer-item"><a href="cart.html" class="footer-tab text-white small fw-bold text-decoration-none"><p class="h4 m-0"><i class="feather-shopping-cart"></i></p>Cart</a></div></div>
      <div class="col"><div class="footer-item selected"><a href="orders.html" class="footer-tab text-white small fw-bold text-decoration-none"><p class="h4 m-0"><i class="feather-shopping-bag"></i></p>Orders</a></div></div>
      <div class="col"><div class="footer-item"><a href="profile.html" class="footer-tab text-white small fw-bold text-decoration-none"><p class="h4 m-0"><i class="feather-user"></i></p>Profile</a></div></div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
import { getFirestore, collection, query, where, onSnapshot, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyADvpUQWo75ExePGoCRirD2mM-lmfM4Cmc",
  authDomain: "von600-7982d.firebaseapp.com",
  projectId: "von600-7982d",
  storageBucket: "von600-7982d.appspot.com",
  messagingSenderId: "164591218045",
  appId: "1:164591218045:web:afe17512e16573e7903014",
  measurementId: "G-E69DMPLXBK"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let markupPrice = 0;
const ordersList = document.getElementById("orders-list");

async function fetchMarkupPrice() {
  try {
    const markupDoc = await getDoc(doc(db, "settings", "markup"));
    if (markupDoc.exists()) markupPrice = parseFloat(markupDoc.data().amount) || 0;
  } catch (err) {
    console.warn("Failed to fetch markup price", err);
  }
}

const isValidOrder = (order) => {
  if (!order.cart || !Array.isArray(order.cart)) return false;
  return order.cart.every(item =>
    typeof item.name === "string" && item.name !== "undefined" &&
    typeof item.quantity === "number" && !isNaN(item.quantity) &&
    (typeof item.total === "number" || (typeof item.price === "number" && !isNaN(item.price)))
  );
};

function getStatusDetails(status) {
  const statusMap = {
    pending: { text: "ðŸ• Pending", class: "status-pending" },
    accepted: { text: "âœ… Accepted", class: "status-accepted" },
    preparing: { text: "ðŸ³ Preparing", class: "status-preparing" },
    "ready-for-pickup": { text: "ðŸ“¦ Ready for Pickup", class: "status-ready-for-pickup" },
    being_delivered: { text: "ðŸšš Being Delivered", class: "status-being_delivered" },
    delivered: { text: "âœ… Delivered", class: "status-delivered" },
    not_delivered: { text: "âŒ Not Delivered", class: "status-not_delivered" },
    cancelled: { text: "âŒ Cancelled", class: "status-cancelled" },
  };
  return statusMap[status] || { text: status, class: "status-gray" };
}

function loadOrdersForEmail(userEmail) {
  const ordersRef = collection(db, "orders");
  const q = query(ordersRef, where("email", "==", userEmail));

  onSnapshot(q, (querySnapshot) => {
    if (querySnapshot.empty) {
      ordersList.innerHTML = `
        <div class="no-orders-screen">
          <i class="feather-shopping-bag"></i>
          <h2>No Orders Yet</h2>
          <p>Why you no dey hung?</p>
        </div>`;
      return;
    }

    const validOrders = querySnapshot.docs
      .map(doc => ({ id: doc.id, ...doc.data() }))
      .filter(order => isValidOrder(order));

    if (!validOrders.length) {
      ordersList.innerHTML = "<p class='text-center text-white'>No valid orders yet.</p>";
      return;
    }

    const groupCartItems = (cart) => {
      const grouped = {};
      cart.forEach(item => {
        const extrasKey = item.extras ? item.extras.map(e => `${e.name}:${e.quantity}`).join("|") : "";
        const sizeKey = item.size || "";
        const key = `${item.name}-${item.price}-${sizeKey}-${extrasKey}`;
        if (!grouped[key]) grouped[key] = { ...item, quantity: 0 };
        grouped[key].quantity += item.quantity;
      });
      return Object.values(grouped);
    };

    const fragment = document.createDocumentFragment();

    validOrders
      .sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis())
      .forEach(order => {
        const orderTime = order.timestamp.toDate().toLocaleString();
        const groupedCart = groupCartItems(order.cart);

        const itemsListSummary = groupedCart.map(item => `${item.quantity}x ${item.name}`).join(", ");
        const itemsListFull = groupedCart.map(item => {
          const itemTotal = typeof item.total === "number"
            ? item.total.toFixed(2)
            : ((item.price + markupPrice) * item.quantity).toFixed(2);

          const sizeInfo = item.size
            ? `<div style="font-size: 0.8rem; color: #aaa;"><strong>Size:</strong> ${item.size}</div>`
            : "";

          const extrasInfo = item.extras?.length
            ? `<div style="font-size: 0.8rem; color: #ccc;"><strong>Extras:</strong> ${item.extras.map(e => `${e.name} Ã—${e.quantity}`).join(", ")}</div>`
            : "";

          return `
            <li class="text-white small mb-2">
              <div><strong>${item.quantity}x ${item.name}</strong> - GHâ‚µ${itemTotal}</div>
              ${sizeInfo}
              ${extrasInfo}
            </li>`;
        }).join("");

        const subtotal = groupedCart.reduce((sum, item) => {
          const itemTotal = typeof item.total === "number" ? item.total : (item.price + markupPrice) * item.quantity;
          return sum + itemTotal;
        }, 0);

        const processingFee = order.processingFee || 2.00;
        const baseDeliveryFee = order.deliveryFee || 3.00;
        const totalMealCount = groupedCart.reduce((sum, item) => sum + item.quantity, 0);
        const finalDeliveryFee = baseDeliveryFee + Math.max(0, (totalMealCount - 1) * 2);
        const total = (subtotal + processingFee + finalDeliveryFee);
        const { text: statusText, class: statusClass } = getStatusDetails(order.status || "pending");

        const orderDiv = document.createElement("div");
        orderDiv.className = "order-box bg-darkish p-3 mb-3 rounded";
        orderDiv.innerHTML = `
          <div class="order-summary">
            <div class="order-summary-left">
              <h5 class="fw-bold text-white">Order on ${orderTime}</h5>
              <p class="order-id text-white-50 small">Order ID: <span>${order.id}</span></p>
              <p class="text-white small">${itemsListSummary}<br> <span class="${statusClass}">${statusText}</span></p>
            </div>
            <div class="order-summary-right">
              <p class="order-total text-white fw-bold">GHâ‚µ${total.toFixed(2)}</p>
            </div>
          </div>
          <div class="order-details">
            <hr class="bg-light">
            <ul class="list-unstyled">${itemsListFull}</ul>
            <hr class="bg-light">
            <p class="text-white small">Subtotal: GHâ‚µ${subtotal.toFixed(2)}</p>
            <p class="text-white small">Processing Fee: GHâ‚µ${processingFee.toFixed(2)}</p>
            <p class="text-white small">Delivery Fee: GHâ‚µ${finalDeliveryFee.toFixed(2)}</p>
            <p class="text-white small">Location: ${order.deliveryDetails?.hostel || ""}, Room ${order.deliveryDetails?.location || ""}</p>
            <hr class="bg-light">
            <p class="order-total text-white fw-bold">Total: GHâ‚µ${total.toFixed(2)}</p>
            <a href="track.html?id=${order.id}" class="btn btn-sm btn-outline-info mt-2 w-100">Track Order</a>
          </div>`;
        orderDiv.addEventListener("click", (e) => {
          if (!e.target.closest("a, button")) orderDiv.classList.toggle("expanded");
        });
        fragment.appendChild(orderDiv);
      });

    ordersList.innerHTML = "";
    ordersList.appendChild(fragment);
  }, (error) => {
    console.error("Error loading orders:", error);
    ordersList.innerHTML = "<p class='text-center text-white'>Error loading orders.</p>";
  });
}

// Wait for auth to load, then fetch orders by user email
onAuthStateChanged(auth, (user) => {
  if (user && user.email) {
    fetchMarkupPrice().then(() => loadOrdersForEmail(user.email));
  } else {
    ordersList.innerHTML = `<p class='text-center text-white mt-5'>Please log in to see your orders.</p>`;
  }
});
</script>

  <script src="https://unpkg.com/feather-icons"></script>
  <script type="module" src="/register-sw.js"></script>


<script>
  document.querySelectorAll('a.footer-tab').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const baseUrl = link.getAttribute('href').split('?')[0];
      const timestamp = Date.now();
      window.location.href = `${baseUrl}?refresh=${timestamp}`;
    });
  });
</script>

</body>
</html>